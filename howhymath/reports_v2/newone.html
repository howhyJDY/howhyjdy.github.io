<div class="modal-header">
    <div class="left">
        <!-- 리포트 생성 250409 -->
        리포트 작성
    </div>
    <img src="https://tutor.howhymath.com/app/img/icon_button_close.png" data-bs-dismiss="modal" aria-label="Close">
</div>

<div class="modal-body">
    <form id="form_create" method="post" action="/reports_v2/create?student_id_str=325">
    <input type="hidden" title="" name="student_id_str" value="325" id="fx-form-student_id_str" class="form-control">
    <!-- 250409 마크업 변경 시작 -->
    <!-- <table class="modal-table">
        <colgroup>
            <col width="25%">
            <col width="75%">
        </colgroup>
        <tbody>
            <tr>
                <th>학생</th>
                <td>이하와</td>
            </tr>
            <tr>
                <th>리포트명</th>
                <td>
                    <div><input type="text" title="" name="name" value="03월 학습리포트" id="fx-form-name" maxlength="10" class="form-control"></div>
                    <div class="note note-error" id="fx-error-name" style="text-align:left;font-size:12px;color:red;padding: 5px 0 0 0;"></div>
                </td>
            </tr>
            <tr>
                <th>시작일</th>
                <td>
                    <div><input type="date" title="" name="start_on" value="2025-03-01" id="fx-form-start_on" data-placeholder="종료일" class="form-control"></div>
                    <div class="note note-error" id="fx-error-start_on" style="text-align:left;font-size:12px;color:red;padding: 5px 0 0 0;"></div>
                </td>
            </tr>
            <tr>
                <th>종료일</th>
                <td>
                    <div><input type="date" title="" name="end_on" value="2025-03-31" id="fx-form-end_on" data-placeholder="종료일" class="form-control"></div>
                    <div class="note note-error" id="fx-error-end_on" style="text-align:left;font-size:12px;color:red;padding: 5px 0 0 0;"></div>
                </td>
            </tr>
            <tr>
                <th>리포트 년월</th>
                <td>
                    <div><input type="month" title="" name="report_mn" value="2025-03" id="fx-form-report_mn" data-placeholder="리포트 년월" class="form-control"></div>
                    <div class="note note-error" id="fx-error-report_mn" style="text-align:left;font-size:12px;color:red;padding: 5px 0 0 0;"></div>
                </td>
            </tr>
        </tbody>
    </table> -->
    <div class="row">
        <div class="input-wrap">
            <dl>
                <dt>학생명</dt>
                <dd>이하와, 홍길동</dd>
            </dl>
            <dl>
                <dt>리포트년월</dt>
                <dd>
                    <div class="row">
                        <div class="inp-box">
                            <div>
                                <input type="month" title="" name="report_mn" value="2025-03" id="fx-form-report_mn" data-placeholder="리포트 년월" class="form-control">
                            </div>
                            <div class="note note-error" id="fx-error-report_mn"></div>
                        </div>
                        <div class="inp-wrap">
                            <div class="inp-box">
                                <div>
                                    <!-- <input type="date" title="" name="start_on" value="2025-03-01" id="fx-form-start_on" data-placeholder="시작일" class="form-control"> -->
                                    <input type="date" title="" name="start_on" value="2025-03-01" id="fx-form-start_on" class="form-control start-date" readonly>
                                </div>
                                <div class="note note-error" id="fx-error-start_on"></div>
                            </div>
                            <span class="etc">~</span>
                            <div class="inp-box">
                                <div>
                                    <!-- <input type="date" title="" name="end_on" value="2025-03-31" id="fx-form-end_on" data-placeholder="종료일" class="form-control"> -->
                                    <input type="date" title="" name="end_on" value="2025-03-31" id="fx-form-end_on" class="form-control end-date" readonly>
                                </div>
                                <div class="note note-error" id="fx-error-end_on"></div>
                            </div>
                            <button type="button" id="openCalendar">날짜 선택</button>

                            <!-- 캘린터 팝업 -->
                            <div id="calendarPopup">
                                <div>
                                    <label for="fx-form-start_on">시작일<span class="start-date"></span></label>
                                    <div id="startCalendar"></div>
                                </div>
                                <span class="etc">~</span>
                                <div>
                                    <label for="fx-form-end_on">종료일<span class="end-date"></span></label>
                                    <div id="endCalendar"></div>
                                </div>
                                <button type="button" id="calendarPopupClose">닫기</button>
                            </div>
                        </div>
                    </div>
                </dd>
            </dl>
            <dl>
                <dt>리포트명</dt>
                <dd>
                    <div><input type="text" title="" name="name" value="03월 학습리포트" id="fx-form-name" maxlength="10" class="form-control"></div>
                    <div class="note note-error" id="fx-error-name"></div>
                </dd>
            </dl>
        </div>
    </div>
    <div class="row flex-column">
        <div class="review-title">
            <strong>입력조건을 선택하세요.</strong>
            <p>조건을 선택하시면 자동으로 문구가 생성됩니다. 생성후 학생별로 총평 문구를 수정할 수 있습니다.</p>
        </div>
        <div class="review-content" id="review-input-area">
            <div class="input-wrap review-top">
                <dl>
                    <dt>인사말</dt>
                    <dd>
                        <div class="inp-box">
                            <label>
                                <input type="radio" name="review1" value="격식있게" checked>
                                격식있게
                            </label>
                            <label>
                                <input type="radio" name="review1" value="친근하게">
                                친근하게
                            </label>
                        </div>
                    </dd>
                </dl>
                <!-- //인사말 -->
            </div>

            <div class="input-wrap review-middle">
                <p><b>항목별 조건 선택하기</b>(최소 4개이상 사용해야 합니다.)</p>
                <div class="list">
                    <dl>
                        <dt>성취도의 변화</dt>
                        <dd>
                            <div class="inp-box">
                                <label>
                                    <input type="radio" name="review2" value="사용하지 않음">
                                    사용하지 않음
                                </label>
                                <label>
                                    <input type="radio" name="review2" value="좋아지고 있음" checked>
                                    좋아지고 있음
                                </label>
                                <label>
                                    <input type="radio" name="review2" value="더 높은 난이도 도전">
                                    더 높은 난이도 도전
                                </label>
                                <label>
                                    <input type="radio" name="review2" value="일시적 하락 보완 필요">
                                    일시적 하락 보완 필요
                                </label>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>수업을 따라오는 정도</dt>
                        <dd>
                            <div class="inp-box">
                                <label>
                                    <input type="radio" name="review3" value="사용하지 않음">
                                    사용하지 않음
                                </label>
                                <label>
                                    <input type="radio" name="review3" value="매우 잘 따라옴" checked>
                                    매우 잘 따라옴
                                </label>
                                <label>
                                    <input type="radio" name="review3" value="대체로 이해, 추가 보충 필요">
                                    대체로 이해, 추가 보충 필요
                                </label>
                                <label>
                                    <input type="radio" name="review3" value="어려움 있음, 개별 보완 필요">
                                    어려움 있음, 개별 보완 필요
                                </label>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>수업중 학습에 대한 태도</dt>
                        <dd>
                            <div class="inp-box">
                                <label>
                                    <input type="radio" name="review4" value="사용하지 않음">
                                    사용하지 않음
                                </label>
                                <label>
                                    <input type="radio" name="review4" value="적극적이고 집중도가 높음" checked>
                                    적극적이고 집중도가 높음
                                </label>
                                <label>
                                    <input type="radio" name="review4" value="대체로 집중, 간혹 산만함">
                                    대체로 집중, 간혹 산만함
                                </label>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>수업 중 참여도</dt>
                        <dd>
                            <div class="inp-box">
                                <label>
                                    <input type="radio" name="review5" value="사용하지 않음">
                                    사용하지 않음
                                </label>
                                <label>
                                    <input type="radio" name="review5" value="참여율이 높음" checked>
                                    참여율이 높음
                                </label>
                                <label>
                                    <input type="radio" name="review5" value="집중력은 좋지만 소극적">
                                    집중력은 좋지만 소극적
                                </label>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>자기주도 학습태도</dt>
                        <dd>
                            <div class="inp-box">
                                <label>
                                    <input type="radio" name="review6" value="사용하지 않음" checked>
                                    사용하지 않음
                                </label>
                                <label>
                                    <input type="radio" name="review6" value="습관이 잘 잡혀 있음">
                                    습관이 잘 잡혀 있음
                                </label>
                                <label>
                                    <input type="radio" name="review6" value="꾸준히 노력 중이며 보완">
                                    꾸준히 노력 중이며 보완
                                </label>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>학생의 정서적인 상태</dt>
                        <dd>
                            <div class="inp-box">
                                <label>
                                    <input type="radio" name="review7" value="사용하지 않음" checked>
                                    사용하지 않음
                                </label>
                                <label>
                                    <input type="radio" name="review7" value="밝고 긍정적 안정감">
                                    밝고 긍정적 안정감
                                </label>
                                <label>
                                    <input type="radio" name="review7" value="감정적 약간의 변화 있음.">
                                    감정적 약간의 변화 있음.
                                </label>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>교사와의 관계</dt>
                        <dd>
                            <div class="inp-box">
                                <label>
                                    <input type="radio" name="review8" value="사용하지 않음" checked>
                                    사용하지 않음
                                </label>
                                <label>
                                    <input type="radio" name="review8" value="친밀하고 예의 있음">
                                    친밀하고 예의 있음
                                </label>
                                <label>
                                    <input type="radio" name="review8" value="낮가림이 있지만 극복중">
                                    낮가림이 있지만 극복중
                                </label>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>수업중 질문 활동</dt>
                        <dd>
                            <div class="inp-box">
                                <label>
                                    <input type="radio" name="review9" value="사용하지 않음" checked>
                                    사용하지 않음
                                </label>
                                <label>
                                    <input type="radio" name="review9" value="적극적으로 질문함">
                                    적극적으로 질문함
                                </label>
                                <label>
                                    <input type="radio" name="review9" value="소극적이지만 대답은 잘함">
                                    소극적이지만 대답은 잘함
                                </label>
                            </div>
                        </dd>
                    </dl>
                </div>
                <!-- //조건 8개 -->
            </div>

            <div class="input-wrap review-bottom">
                <dl>
                    <dt>맺음말</dt>
                    <dd>
                        <div class="inp-box">
                            <label>
                                <input type="radio" name="review10" value="좋은 흐름 유지 (일반적 맺음)" checked>
                                좋은 흐름 유지 (일반적 맺음)
                            </label>
                            <label>
                                <input type="radio" name="review10" value="조금 흔들리다 다시 회복되는 중">
                                조금 흔들리다 다시 회복되는 중
                            </label>
                            <label>
                                <input type="radio" name="review10" value="반편성 등 시간 변화 예고">
                                반편성 등 시간 변화 예고
                            </label>
                            <label>
                                <input type="radio" name="review10" value="평가 시험 예고">
                                평가 시험 예고
                            </label>
                            <label>
                                <input type="radio" name="review10" value="학습 상담 예고">
                                학습 상담 예고
                            </label>
                            <label>
                                <input type="radio" name="review10" value="보충학습 계획">
                                보충학습 계획
                            </label>
                        </div>
                        <div class="inp-box">
                            <input type="radio" name="review10" id="review-etc">
                            <label for="review-etc">기타 (직접입력)</label>
                            <div class="textarea-box">
                                <textarea name="review10" id="review-etc-txtarea" data-max="750" placeholder="750자 이내로 작성해주세요.\n상단 항목별 조건값에 따라 작성글자수는 달라질 수 있습니다."></textarea>
                            </div>
                        </div>
                    </dd>
                </dl>
                <!-- //맺음말 -->
            </div>
        </div>
    </div>
    <div class="modal-bottom-btn-box">
        <button type="button" class="cancle-btn" data-bs-dismiss="modal">취소</button>
        <button type="submit" class="save-btn">저장</button>
    </div>
    <!-- 250409 마크업 변경 끝 -->
    </form>
</div>

<!-- jQuery UI 한글 로케일 CDN -->
<script src="https://code.jquery.com/ui/1.13.2/i18n/datepicker-ko.js"></script>
<script type="text/javascript">
    const form = document.getElementById("form_create");
    const textarea = document.getElementById("review-etc-txtarea");
    const listContainer = document.querySelector(".list");

    const setTextareaLimits = (nonUseCount) => {
        let max, height, placeholder;
        if (nonUseCount < 2) {
            max = 250;
            height = "120px";
            placeholder = "250자 이내로 작성해주세요.\n상단 항목별 조건값에 따라 작성글자수는 달라질 수 있습니다.";
        } else if (nonUseCount < 4) {
            max = 500;
            height = "190px";
            placeholder = "500자 이내로 작성해주세요.\n상단 항목별 조건값에 따라 작성글자수는 달라질 수 있습니다.";
        } else {
            max = 750;
            height = "310px";
            placeholder = "750자 이내로 작성해주세요.\n상단 항목별 조건값에 따라 작성글자수는 달라질 수 있습니다.";
        }
        textarea.dataset.max = max;
        textarea.style.height = height;
        textarea.setAttribute("placeholder", placeholder);
    };

    const validateTextarea = () => {
        const limit = parseInt(textarea.dataset.max, 10) || 750;
        const plainText = textarea.value.replace(/<[^>]*>/g, "");
        if (plainText.length > limit) {
            textarea.value = plainText.substring(0, limit);
            textarea.classList.add("error");
            setTimeout(() => textarea.classList.remove("error"), 1000);
        }
    };

    const limitTextareaHeight = () => {
        while (textarea.scrollHeight > textarea.clientHeight) {
            textarea.value = textarea.value.slice(0, -1);
        }
    };

    // radio 변경 이벤트 감지
    listContainer.addEventListener("change", function (e) {
        if (e.target.type === "radio" && e.target.value) {
            const nonUseCount = document.querySelectorAll('input[type="radio"][value="사용하지 않음"]:checked').length;
            setTextareaLimits(nonUseCount);
            validateTextarea();
            limitTextareaHeight();
        }
    });

    // textarea 입력 제한
    textarea.addEventListener("input", function (e) {
        if (!e.isTrusted) return;
        validateTextarea();
        limitTextareaHeight();
    });

    // textarea 높이 감지
    new ResizeObserver(() => {
        validateTextarea();
        limitTextareaHeight();
    }).observe(textarea);

    // 폼 제출 전 유효성 검사
    form.addEventListener("submit", function (e) {
        const count = document.querySelectorAll('input[type="radio"][value="사용하지 않음"]:checked').length;
        if (count >= 5) {
            document.querySelector(".list").classList.add("error");
            setTimeout(() => {
                document.querySelector(".list").classList.remove("error");
            }, 3000);
            e.preventDefault();
        }
    });

    /* 데이터피커 한글화 */
    $.datepicker.setDefaults({
        dateFormat: 'yy-mm-dd',
        prevText: '이전 달',
        nextText: '다음 달',
        monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
        monthNamesShort: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
        dayNames: ['일', '월', '화', '수', '목', '금', '토'],
        dayNamesShort: ['일', '월', '화', '수', '목', '금', '토'],
        dayNamesMin: ['일', '월', '화', '수', '목', '금', '토'],
        showMonthAfterYear: true,
        yearSuffix: '년'
    });
    
    // 캘린더 팝업 로직
    $("#openCalendar").on("click", function () {
        $("#calendarPopup").fadeIn().css("display", "flex");
    });

    $(document).on("mousedown", function (e) {
        setTimeout(() => {
            if (!$(e.target).closest("#calendarPopup, #openCalendar, .ui-datepicker").length) {
                $("#calendarPopup").fadeOut();
            }
        }, 10);
    });

    $("#calendarPopupClose").on("click", function () {
        $("#calendarPopup").fadeOut();
    });

    $("#startCalendar").datepicker({
        dateFormat: "yy-mm-dd",
        onSelect: function(dateText) {
            $("#fx-form-start_on").val(dateText);
            $(".start-date").text(dateText);
        }
    });

    $("#endCalendar").datepicker({
        dateFormat: "yy-mm-dd",
        onSelect: function (dateText) {
            $("#fx-form-end_on").val(dateText);
            $(".end-date").text(dateText);
        }
    });
</script>